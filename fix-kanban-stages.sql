-- =====================================================
-- SQL команды для исправления удаления стадий
-- =====================================================
-- Скопируйте и вставьте в SQL Editor в Supabase
-- =====================================================

-- Создаем функцию для обработки удаления стадии
-- При удалении стадии все сделки с этой стадией
-- автоматически перемещаются на первую доступную стадию
CREATE OR REPLACE FUNCTION handle_stage_deletion()
RETURNS TRIGGER AS $$
BEGIN
  -- Обновляем все сделки с удаленной стадией на первую доступную стадию
  UPDATE deals 
  SET stage = (
    SELECT id FROM kanban_stages 
    WHERE id != OLD.id 
    ORDER BY order_num ASC 
    LIMIT 1
  )
  WHERE stage = OLD.id;
  
  RETURN OLD;
END;
$$ LANGUAGE plpgsql;

-- Удаляем триггер если он существует
DROP TRIGGER IF EXISTS before_stage_delete ON kanban_stages;

-- Создаем триггер перед удалением стадии
CREATE TRIGGER before_stage_delete
BEFORE DELETE ON kanban_stages
FOR EACH ROW
EXECUTE FUNCTION handle_stage_deletion();

-- =====================================================
-- Готово!
-- =====================================================
-- Теперь при удалении стадии:
-- 1. Все сделки с этой стадией автоматически перемещаются
--    на первую доступную стадию (с наименьшим order_num)
-- 2. Стадия удаляется из базы
-- 3. После обновления страницы удаленные стадии не вернутся
-- =====================================================
